version: '1.0'
steps:
  build_step:
    type: build
    image_name: ncodefresh/test-merge-candidate
    description: Building code...
    working_directory: ${{main_clone}}

  push_to_local_registry:
    description: Storing successful build locally
    type: push
    candidate: ${{build_step}}
    tag: ${{CF_BRANCH_TAG_NORMALIZED}}

  compose_test:
    type: composition
    title: Compose with Dbs & run tests
    description: Running tests...
    composition: ./docker-compose.yml
    composition_candidates:
      test:
        image: ncodefresh/test-merge-candidate:${{CF_BRANCH_TAG_NORMALIZED}}
        links:
          - db
        environment:
          - MYSQL_ROOT_PASSWORD=${{MYSQL_ROOT_PASSWORD}}
          - MYSQL_USER=${{MYSQL_USER}}
          - MYSQL_PASSWORD=${{MYSQL_PASSWORD}}
          - MYSQL_DATABASE=${{MYSQL_DATABASE}}
          - MYSQL_HOST=${{MYSQL_HOST}}
    composition_variables:
      - MYSQL_ROOT_PASSWORD=${{MYSQL_ROOT_PASSWORD}}
      - MYSQL_USER=${{MYSQL_USER}}
      - MYSQL_PASSWORD=${{MYSQL_PASSWORD}}
      - MYSQL_DATABASE=${{MYSQL_DATABASE}}
      - MYSQL_HOST=${{MYSQL_HOST}}